networks:
  agrosolutions-network:
    driver: bridge
    name: agrosolutions-network

services:
  # üóÑÔ∏è Keycloak Database
  keycloak-db:
    image: postgres:16-alpine
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agrosolutions-network

  # üîê Keycloak (Identity Provider)
  keycloak:
    image: quay.io/keycloak/keycloak:26.5.2
    container_name: keycloak
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
    ports:
      - "8080:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 90s
    networks:
      - agrosolutions-network

  # ÔøΩ RabbitMQ (Message Broker)
  rabbitmq:
    image: rabbitmq:4-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agrosolutions-network

  # ÔøΩüìä Observability Stack
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - agrosolutions-network

  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    networks:
      - agrosolutions-network

  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    command: [ "-config.file=/etc/tempo-config.yml" ]
    volumes:
      - ./observability/tempo-config.yml:/etc/tempo-config.yml
    ports:
      - "3200:3200" # Tempo UI
      - "4317"      # OTLP gRPC
    networks:
      - agrosolutions-network

  otel-collector:
    image: otel/opentelemetry-collector:latest
    container_name: otel-collector
    command: [ "--config=/etc/otel-collector-config.yml" ]
    volumes:
      - ./observability/otel-collector-config.yml:/etc/otel-collector-config.yml
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "8889:8889" # Prometheus exporter
    depends_on:
      - loki
      - tempo
    networks:
      - agrosolutions-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - ./observability/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    depends_on:
      - prometheus
      - loki
      - tempo
    networks:
      - agrosolutions-network

  # üöÄ Identity API (Aplica√ß√£o Principal)
  identity-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: "${BUILD_DATE:-2024-01-01T00:00:00Z}"
        VERSION: "${VERSION:-1.0.0}"
        REVISION: "${REVISION:-dev}"
    container_name: identity-api
    ports:
      - "5001:8080"
    depends_on:
      keycloak:
        condition: service_healthy
      otel-collector:
        condition: service_started
    environment:
      # ASP.NET Core
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080

      # JWT Configuration
      - Jwt__Authority=http://keycloak:8080/realms/agrosolutions
      - Jwt__Audience=agrosolutions-api

      # Keycloak Integration
      - KeycloakConfiguration__BaseUrl=http://keycloak:8080
      - KeycloakConfiguration__TokenEndpointPath=/realms/master/protocol/openid-connect/token
      - KeycloakConfiguration__UsersEndpointPath=/admin/realms/agrosolutions/users
      - KeycloakConfiguration__TargetRealm=agrosolutions
      - KeycloakConfiguration__Audience=http://keycloak:8080
      - KeycloakConfiguration__AdminClientId=agrosolutions-api-service-account
      - KeycloakConfiguration__AdminClientSecret=7LF1zdJRb0KppOY2LNrmokWZvnvH0nXX
      - KeycloakConfiguration__ApiClientId=agrosolutions-api
      - KeycloakConfiguration__ApiClientSecret=mev3cV6wKPvu42AItT1dDWhxjHGKHhJe

      # OpenTelemetry Configuration
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=agrosolutions-identity-api
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=development,service.version=1.0.0
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=otlp
      - OTEL_LOGS_EXPORTER=otlp

      # RabbitMQ Configuration
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    read_only: false
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    networks:
      - agrosolutions-network

volumes:
  keycloak_db_data:
    driver: local
  rabbitmq_data:
    driver: local
